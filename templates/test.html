{% extends "base.html" %}

{% block title %}Math Trainer - Test{% endblock %}

{% block additional_styles %}
<style>
    .test-container {
        max-width: 800px;
        margin: 2rem auto;
        padding: 0 1rem;
    }

    .timer-container {
        position: relative;
        width: 180px;
        height: 180px;
        margin: 0 auto 20px;
    }

    .timer-ring {
        width: 100%;
        height: 100%;
        border: 12px solid #f0f0f0;
        border-top: 12px solid #28a745;
        border-radius: 50%;
        transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
    }

    #timer {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        font-size: 2.5em;
        font-weight: bold;
        font-family: 'Courier New', monospace;
        color: #2c3e50;
    }

    .question-display {
        text-align: center;
        font-size: 1.5em;
        margin: 30px 0;
        padding: 20px;
        background: white;
        border-radius: 15px;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        transition: all 0.3s ease;
    }

    .question-display.pulse {
        animation: pulse 0.5s cubic-bezier(0.4, 0, 0.6, 1);
    }

    @keyframes pulse {
        0%, 100% { transform: scale(1); }
        50% { transform: scale(1.05); }
    }

    .progress-bar {
        height: 10px;
        border-radius: 5px;
        transition: width 0.5s ease-in-out;
        background: linear-gradient(90deg, #28a745, #20c997);
    }

    .key-hint {
        background: #f8f9fa;
        padding: 15px;
        border-radius: 10px;
        margin-top: 30px;
        font-size: 1.1em;
        color: #6c757d;
        text-align: center;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }

    .key-hint kbd {
        background: #343a40;
        color: white;
        padding: 3px 8px;
        border-radius: 5px;
        font-size: 0.9em;
        box-shadow: 0 2px 0 rgba(0,0,0,0.2);
    }

    .action-buttons {
        text-align: center;
        margin: 2rem 0;
    }

    .action-buttons button {
        margin: 0 10px;
        padding: 12px 24px;
        font-size: 1.1em;
        transition: all 0.3s ease;
    }

    .action-buttons button:hover {
        transform: translateY(-2px);
    }

    .modal-content {
        border-radius: 15px;
    }

    .modal-header {
        background: #f8f9fa;
        border-radius: 15px 15px 0 0;
    }

    .category-select {
        max-height: 400px;
        overflow-y: auto;
    }

    .category-group {
        margin-bottom: 15px;
    }

    .category-group h6 {
        color: #2c3e50;
        margin-bottom: 10px;
    }

    .subcategory-list {
        list-style: none;
        padding-left: 20px;
    }

    .subcategory-item {
        margin: 5px 0;
    }

    .subcategory-item label {
        display: flex;
        align-items: center;
        cursor: pointer;
    }

    .subcategory-item input[type="radio"] {
        margin-right: 10px;
    }
</style>
{% endblock %}

{% block content %}
<div class="test-container">
    <div class="card shadow-sm">
        <div class="card-body p-4">
            <div class="progress mb-4">
                <div class="progress-bar" role="progressbar" style="width: 0%" id="progress-bar"></div>
            </div>

            <div class="timer-container">
                <div class="timer-ring"></div>
                <div id="timer">{{ test.time_limit // 60 }}:00</div>
            </div>

            <div class="question-display">
                <h3 id="progress" class="mb-3">Question 1/{{ test.total_questions }}</h3>
                <p class="text-muted mb-0">Press <kbd>Space</kbd> to complete this question</p>
            </div>

            <div class="action-buttons">
                <button id="wrong-answer" class="btn btn-warning btn-lg">
                    <i class="bi bi-x-circle-fill me-2"></i>Mark Wrong (W)
                </button>
                <button id="end-test" class="btn btn-danger btn-lg">
                    <i class="bi bi-stop-circle-fill me-2"></i>End Test (E)
                </button>
            </div>

            <div class="key-hint">
                <div class="row">
                    <div class="col-md-4">
                        <kbd>Space</kbd> Next Question
                    </div>
                    <div class="col-md-4">
                        <kbd>W</kbd> Mark Wrong
                    </div>
                    <div class="col-md-4">
                        <kbd>E</kbd> End Test
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Wrong Question Modal -->
<div class="modal fade" id="wrongQuestionModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Select Problem Category</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="category-select">
                    {% for category, subcategories in categories.items() %}
                    <div class="category-group">
                        <h6>{{ category }}</h6>
                        <div class="subcategory-list">
                            {% for subcategory in subcategories %}
                            <div class="subcategory-item">
                                <label>
                                    <input type="radio" name="category" value="{{ category }}/{{ subcategory }}">
                                    {{ subcategory }}
                                </label>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="confirm-category">Confirm</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
const testData = {
    testId: '{{ test.test_id }}',
    totalQuestions: {{ test.total_questions }},
    timeLimit: {{ test.time_limit }},
    startTime: {{ test.start_time }},
    currentQuestion: {{ test.current_question }}
};

let timer;
let currentQuestion = testData.currentQuestion;
let questionTimes = [];
let testActive = true;

function updateTimer(timeLeft) {
    const minutes = Math.floor(timeLeft / 60);
    const seconds = timeLeft % 60;
    document.getElementById('timer').textContent = 
        `${minutes}:${seconds.toString().padStart(2, '0')}`;
    
    const progress = (1 - timeLeft / testData.timeLimit) * 100;
    document.querySelector('.timer-ring').style.transform = 
        `rotate(${progress * 3.6}deg)`;
}

function updateProgress() {
    const progress = (currentQuestion / testData.totalQuestions) * 100;
    document.getElementById('progress').textContent = 
        `Question ${currentQuestion + 1}/${testData.totalQuestions}`;
    document.getElementById('progress-bar').style.width = `${progress}%`;

    // Add pulse animation
    const display = document.querySelector('.question-display');
    display.classList.add('pulse');
    setTimeout(() => display.classList.remove('pulse'), 500);
}

function recordQuestion(isWrong = false, category = null) {
    const questionData = {
        test_id: testData.testId,
        question_number: currentQuestion,
        time: Math.floor(Date.now() / 1000) - testData.startTime
    };

    if (isWrong && category) {
        questionData.wrong_data = { category };
    }

    fetch('/api/record-question', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(questionData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            currentQuestion++;
            updateProgress();
            
            if (currentQuestion >= testData.totalQuestions) {
                endTest();
            }
        }
    })
    .catch(error => console.error('Error:', error));
}

function endTest() {
    testActive = false;
    clearInterval(timer);
    window.location.href = `/results/${testData.testId}`;
}

// Initialize timer
let timeLeft = testData.timeLimit;
timer = setInterval(() => {
    if (testActive) {
        timeLeft--;
        updateTimer(timeLeft);
        
        if (timeLeft <= 0) {
            endTest();
        }
    }
}, 1000);

// Keyboard shortcuts
document.addEventListener('keydown', (e) => {
    if (!testActive) return;
    
    if (e.code === 'Space' && !e.repeat) {
        e.preventDefault();
        recordQuestion();
    } else if (e.key.toLowerCase() === 'w' && !e.repeat) {
        e.preventDefault();
        const modal = new bootstrap.Modal(document.getElementById('wrongQuestionModal'));
        modal.show();
    } else if (e.key.toLowerCase() === 'e' && !e.repeat) {
        e.preventDefault();
        endTest();
    }
});

// Button handlers
document.getElementById('wrong-answer').addEventListener('click', () => {
    const modal = new bootstrap.Modal(document.getElementById('wrongQuestionModal'));
    modal.show();
});

document.getElementById('end-test').addEventListener('click', endTest);

document.getElementById('confirm-category').addEventListener('click', () => {
    const selectedCategory = document.querySelector('input[name="category"]:checked');
    if (selectedCategory) {
        const modal = bootstrap.Modal.getInstance(document.getElementById('wrongQuestionModal'));
        modal.hide();
        recordQuestion(true, selectedCategory.value);
    }
});

// Initial setup
updateTimer(timeLeft);
updateProgress();
</script>
{% endblock %}
