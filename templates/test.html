{% extends "base.html" %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-md-8 offset-md-2">
            <div class="card">
                <div class="card-body">
                    <div id="test-container">
                        <div id="question-display" class="mb-4">
                            <h3 class="question-text mb-3"></h3>
                            <div class="input-group mb-3">
                                <input type="text" id="answer-input" class="form-control" placeholder="Enter your answer">
                                <button id="submit-answer" class="btn btn-primary">Submit</button>
                            </div>
                            <div class="text-muted">Press SPACE to start timing each question</div>
                        </div>
                        <div id="timer" class="mb-3">Time: 0.0s</div>
                        <div id="progress" class="mb-3">Question 0/0</div>
                        <div id="test-complete" style="display: none;">
                            <h3>Test Complete!</h3>
                            <div id="review-container">
                                <h4>Review Wrong Answers</h4>
                                <div id="wrong-answers-list"></div>
                            </div>
                            <button id="submit-test" class="btn btn-success mt-3">Submit Test</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Problem Category Modal -->
<div class="modal fade" id="categoryModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Select Problem Category</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label">Main Category</label>
                    <select id="mainCategory" class="form-select">
                        <option value="">Select category...</option>
                    </select>
                </div>
                <div class="mb-3">
                    <label class="form-label">Subcategory</label>
                    <select id="subCategory" class="form-select">
                        <option value="">Select subcategory...</option>
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" id="saveCategoryBtn">Save</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
const PROBLEM_CATEGORIES = {
    'Geometry': [
        'Angle Chasing',
        'Congruence and Similarity',
        'Circle Problems',
        'Polygon Properties',
        'Triangles',
        'Coordinate Geometry',
        '3D Geometry',
        'Special Triangles'
    ],
    'Algebra': [
        'Linear Equations',
        'Quadratics',
        'Polynomials',
        'Exponential and Logarithmic Problems',
        'Functional Equations',
        'Sequences and Series'
    ],
    'Arithmetic and Number Theory': [
        'Prime Factorization',
        'Divisibility',
        'Modular Arithmetic',
        'Number Bases',
        'Clock Problems',
        'Digit Problems',
        'Consecutive Numbers'
    ],
    'Word Problems': [
        'Speed, Distance, and Rate',
        'Work Problems',
        'Mixture Problems',
        'Age Problems',
        'Percentage Problems',
        'Proportion and Ratio Problems'
    ],
    'Counting and Probability': [
        'Permutations',
        'Combinations',
        'Probability',
        'Expected Value',
        'Set Problems'
    ],
    'Miscellaneous Problems': [
        'Clock Problems',
        'Calendar Problems',
        'Pattern Problems',
        'Optimization Problems',
        'Logic Problems',
        'Estimation Problems'
    ]
};

let currentQuestion = 0;
let questions = [];
let startTime = null;
let questionTimes = [];
let wrongAnswers = [];
let categories = {};
let waitingForSpace = true;

// Initialize categories in modal
const mainCategorySelect = document.getElementById('mainCategory');
const subCategorySelect = document.getElementById('subCategory');

Object.keys(PROBLEM_CATEGORIES).forEach(category => {
    const option = document.createElement('option');
    option.value = category;
    option.textContent = category;
    mainCategorySelect.appendChild(option);
});

mainCategorySelect.addEventListener('change', () => {
    const category = mainCategorySelect.value;
    subCategorySelect.innerHTML = '<option value="">Select subcategory...</option>';
    if (category && PROBLEM_CATEGORIES[category]) {
        PROBLEM_CATEGORIES[category].forEach(sub => {
            const option = document.createElement('option');
            option.value = sub;
            option.textContent = sub;
            subCategorySelect.appendChild(option);
        });
    }
});

// Handle spacebar for timing
document.addEventListener('keydown', (e) => {
    if (e.code === 'Space' && waitingForSpace) {
        e.preventDefault();
        startTime = Date.now();
        waitingForSpace = false;
        document.getElementById('timer').textContent = 'Timer started';
    }
});

function startTest() {
    fetch('/api/get-test-questions')
        .then(response => response.json())
        .then(data => {
            questions = data.questions;
            showQuestion(0);
        });
}

function showQuestion(index) {
    if (index >= questions.length) {
        showTestComplete();
        return;
    }
    
    currentQuestion = index;
    document.querySelector('.question-text').textContent = questions[index].question;
    document.getElementById('answer-input').value = '';
    document.getElementById('progress').textContent = `Question ${index + 1}/${questions.length}`;
    waitingForSpace = true;
    startTime = null;
    document.getElementById('timer').textContent = 'Press SPACE to start';
}

function checkAnswer() {
    if (!startTime) {
        alert('Please press SPACE to start the timer first!');
        return;
    }

    const endTime = Date.now();
    const timeSpent = (endTime - startTime) / 1000;
    questionTimes.push(timeSpent);

    const userAnswer = document.getElementById('answer-input').value.trim();
    const correct = userAnswer === questions[currentQuestion].answer;

    if (!correct) {
        wrongAnswers.push({
            question: questions[currentQuestion].question,
            userAnswer: userAnswer,
            correctAnswer: questions[currentQuestion].answer,
            index: currentQuestion
        });
    }

    showQuestion(currentQuestion + 1);
}

function showTestComplete() {
    document.getElementById('question-display').style.display = 'none';
    document.getElementById('timer').style.display = 'none';
    document.getElementById('progress').style.display = 'none';
    document.getElementById('test-complete').style.display = 'block';

    const wrongAnswersList = document.getElementById('wrong-answers-list');
    wrongAnswersList.innerHTML = wrongAnswers.map((wrong, index) => `
        <div class="wrong-answer-item mb-3">
            <div class="question mb-2">Question ${wrong.index + 1}: ${wrong.question}</div>
            <div class="answers mb-2">
                Your answer: ${wrong.userAnswer}<br>
                Correct answer: ${wrong.correctAnswer}
            </div>
            <button class="btn btn-outline-primary btn-sm categorize-btn" 
                    onclick="showCategoryModal(${index})">
                Categorize Problem
            </button>
            <div class="selected-category"></div>
        </div>
    `).join('');
}

function showCategoryModal(wrongAnswerIndex) {
    const modal = new bootstrap.Modal(document.getElementById('categoryModal'));
    document.getElementById('saveCategoryBtn').onclick = () => {
        const mainCat = mainCategorySelect.value;
        const subCat = subCategorySelect.value;
        if (mainCat && subCat) {
            categories[wrongAnswerIndex] = { main: mainCat, sub: subCat };
            const categoryDiv = wrongAnswers[wrongAnswerIndex].element
                .querySelector('.selected-category');
            categoryDiv.textContent = `${mainCat} - ${subCat}`;
            modal.hide();
        }
    };
    modal.show();
}

document.getElementById('submit-answer').addEventListener('click', checkAnswer);
document.getElementById('answer-input').addEventListener('keypress', (e) => {
    if (e.key === 'Enter') checkAnswer();
});

document.getElementById('submit-test').addEventListener('click', () => {
    const testData = {
        questions: questions.map((q, i) => ({
            question: q.question,
            answer: q.answer,
            userAnswer: i in wrongAnswers ? wrongAnswers[i].userAnswer : q.answer,
            time: questionTimes[i],
            category: categories[i] || null
        }))
    };

    fetch('/api/submit-test', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(testData)
    })
    .then(response => response.json())
    .then(data => {
        window.location.href = '/results/' + data.test_id;
    });
});

// Start the test when page loads
startTest();
</script>
{% endblock %}
