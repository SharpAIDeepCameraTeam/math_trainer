{% extends "base.html" %}

{% block styles %}
<style>
.circle-timer {
    position: relative;
    width: 300px;
    height: 300px;
    margin: 0 auto;
}

.circle-timer canvas {
    position: absolute;
    top: 0;
    left: 0;
}

.circle-timer .timer-text {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    text-align: center;
    width: 100%;
}

.circle-timer .timer-text .time {
    font-size: 3rem;
    font-weight: bold;
    margin-bottom: 0.5rem;
}

.circle-timer .timer-text .question {
    font-size: 1.5rem;
    color: #666;
}

.pulse {
    animation: pulse-animation 0.5s ease-out;
}

@keyframes pulse-animation {
    0% {
        transform: scale(1);
    }
    50% {
        transform: scale(1.05);
    }
    100% {
        transform: scale(1);
    }
}

.preset-card {
    cursor: pointer;
    transition: transform 0.2s;
}

.preset-card:hover {
    transform: scale(1.02);
}

.preset-card.selected {
    border-color: #0d6efd;
    box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
}
</style>
{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-md-8 offset-md-2">
            <!-- Test Configuration -->
            <div id="test-config" class="card mb-4">
                <div class="card-body">
                    <h3 class="mb-4">Configure Test</h3>
                    
                    <!-- Preset Tests -->
                    <div class="row g-4 mb-4">
                        <div class="col-md-4">
                            <div class="card preset-card h-100" data-preset="mathcounts">
                                <div class="card-body">
                                    <h5>MATHCOUNTS</h5>
                                    <p class="mb-2">Sprint Round</p>
                                    <ul class="list-unstyled">
                                        <li>30 Questions</li>
                                        <li>40 Minutes</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card preset-card h-100" data-preset="amc8">
                                <div class="card-body">
                                    <h5>AMC 8</h5>
                                    <p class="mb-2">Standard Test</p>
                                    <ul class="list-unstyled">
                                        <li>25 Questions</li>
                                        <li>40 Minutes</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card preset-card h-100" data-preset="mandelbrot">
                                <div class="card-body">
                                    <h5>Mandelbrot</h5>
                                    <p class="mb-2">Individual Round</p>
                                    <ul class="list-unstyled">
                                        <li>40 Questions</li>
                                        <li>60 Minutes</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Custom Configuration -->
                    <div class="custom-config">
                        <h5 class="mb-3">Custom Configuration</h5>
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label">Number of Questions</label>
                                <input type="number" id="num-questions" class="form-control" value="30" min="1">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Time Limit (minutes)</label>
                                <input type="number" id="time-limit" class="form-control" value="40" min="1">
                            </div>
                        </div>
                    </div>

                    <div class="text-center mt-4">
                        <button id="start-test" class="btn btn-primary btn-lg">Start Test</button>
                    </div>
                </div>
            </div>

            <!-- Test Interface -->
            <div id="test-interface" class="card" style="display: none;">
                <div class="card-body">
                    <div id="test-container" class="text-center">
                        <div id="active-test" class="mb-4">
                            <div class="circle-timer">
                                <canvas id="timer-canvas"></canvas>
                                <div class="timer-text">
                                    <div class="time" id="timer">Press SPACE to start</div>
                                    <div class="question">Question <span id="current-question">1</span></div>
                                </div>
                            </div>

                            <div class="mt-4">
                                <div class="chart-container" style="position: relative; height: 200px;">
                                    <canvas id="timeChart"></canvas>
                                </div>
                            </div>

                            <div id="review-buttons" class="mt-4" style="display: none;">
                                <p class="text-muted mb-3">Review your answers before finishing</p>
                                <button id="finish-test" class="btn btn-success">
                                    <i class="bi bi-check-circle me-2"></i>Finish Test
                                </button>
                            </div>

                            <button id="end-test" class="btn btn-danger mt-4">
                                <i class="bi bi-stop-circle me-2"></i>End Test Early
                            </button>
                        </div>
                        
                        <div id="test-complete" style="display: none;">
                            <h3 class="mb-4">Test Complete!</h3>
                            
                            <div class="row mb-4">
                                <div class="col-12">
                                    <div class="chart-container" style="position: relative; height:300px;">
                                        <canvas id="finalTimeChart"></canvas>
                                    </div>
                                </div>
                            </div>

                            <div class="row justify-content-center">
                                <div class="col-md-8">
                                    <div class="form-group mb-4">
                                        <label class="form-label">Enter wrong question numbers (comma-separated):</label>
                                        <input type="text" id="wrong-questions" class="form-control" placeholder="e.g., 2,5,8">
                                    </div>
                                    
                                    <div id="wrong-answers-list" class="text-start mb-4"></div>
                                    
                                    <button id="submit-test" class="btn btn-success">Save Results</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Problem Category Modal -->
<div class="modal fade" id="categoryModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Select Problem Category</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label">Main Category</label>
                    <select id="mainCategory" class="form-select">
                        <option value="">Select category...</option>
                    </select>
                </div>
                <div class="mb-3">
                    <label class="form-label">Subcategory</label>
                    <select id="subCategory" class="form-select">
                        <option value="">Select subcategory...</option>
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" id="saveCategoryBtn">Save</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
const PROBLEM_CATEGORIES = {
    'Geometry': [
        'Angle Chasing',
        'Congruence and Similarity',
        'Circle Problems',
        'Polygon Properties',
        'Triangles',
        'Coordinate Geometry',
        '3D Geometry',
        'Special Triangles'
    ],
    'Algebra': [
        'Linear Equations',
        'Quadratics',
        'Polynomials',
        'Exponential and Logarithmic Problems',
        'Functional Equations',
        'Sequences and Series'
    ],
    'Arithmetic and Number Theory': [
        'Prime Factorization',
        'Divisibility',
        'Modular Arithmetic',
        'Number Bases',
        'Clock Problems',
        'Digit Problems',
        'Consecutive Numbers'
    ],
    'Word Problems': [
        'Speed, Distance, and Rate',
        'Work Problems',
        'Mixture Problems',
        'Age Problems',
        'Percentage Problems',
        'Proportion and Ratio Problems'
    ],
    'Counting and Probability': [
        'Permutations',
        'Combinations',
        'Probability',
        'Expected Value',
        'Set Problems'
    ],
    'Miscellaneous Problems': [
        'Clock Problems',
        'Calendar Problems',
        'Pattern Problems',
        'Optimization Problems',
        'Logic Problems',
        'Estimation Problems'
    ]
};

const TEST_PRESETS = {
    mathcounts: {
        name: 'MATHCOUNTS Sprint Round',
        questions: 30,
        timeLimit: 40
    },
    amc8: {
        name: 'AMC 8',
        questions: 25,
        timeLimit: 40
    },
    mandelbrot: {
        name: 'Mandelbrot Individual Round',
        questions: 40,
        timeLimit: 60
    }
};

let currentQuestion = 1;
let startTime = null;
let questionStartTime = null;
let questionTimes = [];
let categories = {};
let canvas = document.getElementById('timer-canvas');
let ctx = canvas.getContext('2d');
let chart = null;
let totalQuestions = 30;
let timeLimit = 40;

// Set canvas size
canvas.width = 300;
canvas.height = 300;

// Handle preset selection
document.querySelectorAll('.preset-card').forEach(card => {
    card.addEventListener('click', () => {
        // Remove selection from other cards
        document.querySelectorAll('.preset-card').forEach(c => c.classList.remove('selected'));
        
        // Select this card
        card.classList.add('selected');
        
        // Update inputs with preset values
        const preset = TEST_PRESETS[card.dataset.preset];
        document.getElementById('num-questions').value = preset.questions;
        document.getElementById('time-limit').value = preset.timeLimit;
    });
});

// Handle test start
document.getElementById('start-test').addEventListener('click', () => {
    totalQuestions = parseInt(document.getElementById('num-questions').value);
    timeLimit = parseInt(document.getElementById('time-limit').value);
    
    document.getElementById('test-config').style.display = 'none';
    document.getElementById('test-interface').style.display = 'block';
    
    // Draw initial empty circle
    drawCircle(0);
});

function formatTime(seconds) {
    const mins = Math.floor(seconds / 60);
    const secs = Math.floor(seconds % 60);
    return `${mins}:${secs.toString().padStart(2, '0')}`;
}

function drawCircle(percentage) {
    const centerX = canvas.width / 2;
    const centerY = canvas.height / 2;
    const radius = Math.min(centerX, centerY) - 10;
    
    // Clear canvas
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    
    // Draw background circle
    ctx.beginPath();
    ctx.arc(centerX, centerY, radius, 0, 2 * Math.PI);
    ctx.strokeStyle = '#eee';
    ctx.lineWidth = 10;
    ctx.stroke();
    
    // Draw progress
    if (percentage > 0) {
        ctx.beginPath();
        ctx.arc(centerX, centerY, radius, -Math.PI / 2, (-Math.PI / 2) + (2 * Math.PI * percentage));
        ctx.strokeStyle = percentage <= 0.3 ? '#4CAF50' : 
                         percentage <= 0.6 ? '#FFC107' : '#F44336';
        ctx.lineWidth = 10;
        ctx.stroke();
    }
}

function pulseTimer() {
    const timerText = document.querySelector('.timer-text');
    timerText.classList.remove('pulse');
    void timerText.offsetWidth; // Trigger reflow
    timerText.classList.add('pulse');
}

function updateTimer() {
    if (!startTime) return;
    
    const now = Date.now();
    const elapsed = (now - startTime) / 1000;
    document.getElementById('timer').textContent = formatTime(elapsed);
    
    // Calculate percentage based on time limit
    const percentage = elapsed / (timeLimit * 60);
    drawCircle(percentage);
    
    requestAnimationFrame(updateTimer);
}

function initializeChart() {
    const ctx = document.getElementById('timeChart').getContext('2d');
    chart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: [],
            datasets: [{
                label: 'Time per Problem',
                data: [],
                borderColor: '#667eea',
                backgroundColor: 'rgba(102, 126, 234, 0.1)',
                tension: 0.4,
                fill: true
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            animation: {
                duration: 750,
                easing: 'easeInOutQuart'
            },
            scales: {
                y: {
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: 'Seconds'
                    }
                },
                x: {
                    title: {
                        display: true,
                        text: 'Problem Number'
                    }
                }
            },
            plugins: {
                legend: {
                    display: false
                }
            }
        }
    });
}

function updateChart() {
    if (!chart) return;
    
    const labels = questionTimes.map((_, i) => `#${i + 1}`);
    const data = questionTimes;
    
    chart.data.labels = labels;
    chart.data.datasets[0].data = data;
    chart.update('show');
}

// Handle spacebar
document.addEventListener('keydown', (e) => {
    if (e.code === 'Space' && document.getElementById('test-interface').style.display !== 'none' && 
        document.getElementById('active-test').style.display !== 'none') {
        e.preventDefault();
        
        if (!startTime) {
            // First press - start the timer
            startTime = Date.now();
            questionStartTime = startTime;
            updateTimer();
            // Initialize chart
            initializeChart();
        } else {
            // Record time for current question
            const timeSpent = (Date.now() - questionStartTime) / 1000;
            questionTimes.push(timeSpent);
            
            if (currentQuestion < totalQuestions) {
                // Start timing next question
                currentQuestion++;
                document.getElementById('current-question').textContent = currentQuestion;
                questionStartTime = Date.now();
                
                // Update chart with new data
                updateChart();
                
                // Pulse the timer
                pulseTimer();
            } else {
                // Show review state
                document.getElementById('current-question').textContent = 'Review';
                document.getElementById('review-buttons').style.display = 'block';
                document.getElementById('end-test').style.display = 'none';
            }
        }
    }
});

document.getElementById('finish-test').addEventListener('click', () => {
    finishTest();
});

document.getElementById('end-test').addEventListener('click', () => {
    finishTest();
});

function finishTest() {
    // Record time for last question if not in review mode
    if (startTime && questionStartTime && currentQuestion <= totalQuestions) {
        const timeSpent = (Date.now() - questionStartTime) / 1000;
        questionTimes.push(timeSpent);
    }
    
    document.getElementById('active-test').style.display = 'none';
    document.getElementById('test-complete').style.display = 'block';
    
    // Initialize and update the final time chart
    const ctx = document.getElementById('finalTimeChart').getContext('2d');
    const finalChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: questionTimes.map((_, i) => `#${i + 1}`),
            datasets: [{
                label: 'Time per Problem',
                data: questionTimes,
                borderColor: '#667eea',
                backgroundColor: 'rgba(102, 126, 234, 0.1)',
                tension: 0.4,
                fill: true
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            animation: {
                duration: 750,
                easing: 'easeInOutQuart'
            },
            scales: {
                y: {
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: 'Seconds'
                    }
                },
                x: {
                    title: {
                        display: true,
                        text: 'Problem Number'
                    }
                }
            },
            plugins: {
                legend: {
                    display: false
                }
            }
        }
    });
}

document.getElementById('wrong-questions').addEventListener('change', (e) => {
    const wrongNums = e.target.value.split(',')
        .map(n => parseInt(n.trim()))
        .filter(n => !isNaN(n) && n > 0 && n <= totalQuestions);
    
    const wrongAnswersList = document.getElementById('wrong-answers-list');
    wrongAnswersList.innerHTML = wrongNums.map((questionNum, index) => `
        <div class="wrong-answer-item mb-3 p-3 border rounded">
            <h5>Question ${questionNum}</h5>
            <div class="mb-2">Time taken: ${questionTimes[questionNum - 1].toFixed(1)}s</div>
            <button class="btn btn-outline-primary btn-sm categorize-btn" 
                    onclick="showCategoryModal(${questionNum})">
                Categorize Problem
            </button>
            <div class="selected-category mt-2"></div>
        </div>
    `).join('');
});

function showCategoryModal(questionNum) {
    const modal = new bootstrap.Modal(document.getElementById('categoryModal'));
    document.getElementById('saveCategoryBtn').onclick = () => {
        const mainCat = mainCategorySelect.value;
        const subCat = subCategorySelect.value;
        if (mainCat && subCat) {
            categories[questionNum] = { main: mainCat, sub: subCat };
            const items = document.querySelectorAll('.wrong-answer-item');
            for (let item of items) {
                if (item.querySelector('h5').textContent === `Question ${questionNum}`) {
                    item.querySelector('.selected-category').textContent = `Category: ${mainCat} - ${subCat}`;
                    break;
                }
            }
            modal.hide();
        }
    };
    modal.show();
}

document.getElementById('submit-test').addEventListener('click', () => {
    const wrongNums = document.getElementById('wrong-questions').value.split(',')
        .map(n => parseInt(n.trim()))
        .filter(n => !isNaN(n) && n > 0 && n <= totalQuestions);

    const testData = {
        totalQuestions: totalQuestions,
        timeLimit: timeLimit,
        times: questionTimes,
        wrongQuestions: wrongNums,
        categories: categories
    };

    fetch('/api/submit-test', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(testData)
    })
    .then(response => response.json())
    .then(data => {
        window.location.href = '/results/' + data.test_id;
    });
});
</script>
{% endblock %}
