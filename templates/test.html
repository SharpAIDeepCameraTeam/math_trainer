{% extends "base.html" %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-md-8 offset-md-2">
            <div class="card">
                <div class="card-body">
                    <div id="test-container" class="text-center">
                        <div id="active-test" class="mb-4">
                            <h3 class="mb-4">Question <span id="current-question">1</span></h3>
                            <div class="timer-display mb-4">
                                <div id="timer" class="display-4 mb-3">Press SPACE to start</div>
                            </div>
                            <div class="text-muted mb-4">Press SPACE to record time and move to next question</div>
                            <button id="end-test" class="btn btn-danger">
                                <i class="bi bi-stop-circle me-2"></i>End Test
                            </button>
                        </div>
                        
                        <div id="test-complete" style="display: none;">
                            <h3 class="mb-4">Test Complete!</h3>
                            <div class="row justify-content-center">
                                <div class="col-md-8">
                                    <div class="form-group mb-4">
                                        <label class="form-label">Enter wrong question numbers (comma-separated):</label>
                                        <input type="text" id="wrong-questions" class="form-control" placeholder="e.g., 2,5,8">
                                    </div>
                                    
                                    <div id="wrong-answers-list" class="text-start mb-4"></div>
                                    
                                    <button id="submit-test" class="btn btn-success">Save Results</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Problem Category Modal -->
<div class="modal fade" id="categoryModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Select Problem Category</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label">Main Category</label>
                    <select id="mainCategory" class="form-select">
                        <option value="">Select category...</option>
                    </select>
                </div>
                <div class="mb-3">
                    <label class="form-label">Subcategory</label>
                    <select id="subCategory" class="form-select">
                        <option value="">Select subcategory...</option>
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" id="saveCategoryBtn">Save</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
const PROBLEM_CATEGORIES = {
    'Geometry': [
        'Angle Chasing',
        'Congruence and Similarity',
        'Circle Problems',
        'Polygon Properties',
        'Triangles',
        'Coordinate Geometry',
        '3D Geometry',
        'Special Triangles'
    ],
    'Algebra': [
        'Linear Equations',
        'Quadratics',
        'Polynomials',
        'Exponential and Logarithmic Problems',
        'Functional Equations',
        'Sequences and Series'
    ],
    'Arithmetic and Number Theory': [
        'Prime Factorization',
        'Divisibility',
        'Modular Arithmetic',
        'Number Bases',
        'Clock Problems',
        'Digit Problems',
        'Consecutive Numbers'
    ],
    'Word Problems': [
        'Speed, Distance, and Rate',
        'Work Problems',
        'Mixture Problems',
        'Age Problems',
        'Percentage Problems',
        'Proportion and Ratio Problems'
    ],
    'Counting and Probability': [
        'Permutations',
        'Combinations',
        'Probability',
        'Expected Value',
        'Set Problems'
    ],
    'Miscellaneous Problems': [
        'Clock Problems',
        'Calendar Problems',
        'Pattern Problems',
        'Optimization Problems',
        'Logic Problems',
        'Estimation Problems'
    ]
};

let currentQuestion = 1;
let startTime = null;
let questionTimes = [];
let categories = {};
let waitingForSpace = true;

// Initialize categories in modal
const mainCategorySelect = document.getElementById('mainCategory');
const subCategorySelect = document.getElementById('subCategory');

Object.keys(PROBLEM_CATEGORIES).forEach(category => {
    const option = document.createElement('option');
    option.value = category;
    option.textContent = category;
    mainCategorySelect.appendChild(option);
});

mainCategorySelect.addEventListener('change', () => {
    const category = mainCategorySelect.value;
    subCategorySelect.innerHTML = '<option value="">Select subcategory...</option>';
    if (category && PROBLEM_CATEGORIES[category]) {
        PROBLEM_CATEGORIES[category].forEach(sub => {
            const option = document.createElement('option');
            option.value = sub;
            option.textContent = sub;
            subCategorySelect.appendChild(option);
        });
    }
});

// Handle spacebar for timing
document.addEventListener('keydown', (e) => {
    if (e.code === 'Space' && document.getElementById('active-test').style.display !== 'none') {
        e.preventDefault();
        
        if (waitingForSpace) {
            // Start timing
            startTime = Date.now();
            waitingForSpace = false;
            document.getElementById('timer').textContent = '0.0s';
            startTimer();
        } else {
            // Record time and move to next question
            const timeSpent = (Date.now() - startTime) / 1000;
            questionTimes.push(timeSpent);
            currentQuestion++;
            document.getElementById('current-question').textContent = currentQuestion;
            waitingForSpace = true;
            startTime = null;
            document.getElementById('timer').textContent = 'Press SPACE to start';
        }
    }
});

function startTimer() {
    if (!startTime || waitingForSpace) return;
    
    const updateTimer = () => {
        if (!startTime || waitingForSpace) return;
        const elapsed = (Date.now() - startTime) / 1000;
        document.getElementById('timer').textContent = elapsed.toFixed(1) + 's';
        requestAnimationFrame(updateTimer);
    };
    
    requestAnimationFrame(updateTimer);
}

document.getElementById('end-test').addEventListener('click', () => {
    if (startTime) {
        const timeSpent = (Date.now() - startTime) / 1000;
        questionTimes.push(timeSpent);
    }
    
    document.getElementById('active-test').style.display = 'none';
    document.getElementById('test-complete').style.display = 'block';
});

document.getElementById('wrong-questions').addEventListener('change', (e) => {
    const wrongNums = e.target.value.split(',')
        .map(n => parseInt(n.trim()))
        .filter(n => !isNaN(n) && n > 0 && n <= currentQuestion);
    
    const wrongAnswersList = document.getElementById('wrong-answers-list');
    wrongAnswersList.innerHTML = wrongNums.map((questionNum, index) => `
        <div class="wrong-answer-item mb-3 p-3 border rounded">
            <h5>Question ${questionNum}</h5>
            <div class="mb-2">Time taken: ${questionTimes[questionNum - 1].toFixed(1)}s</div>
            <button class="btn btn-outline-primary btn-sm categorize-btn" 
                    onclick="showCategoryModal(${questionNum})">
                Categorize Problem
            </button>
            <div class="selected-category mt-2"></div>
        </div>
    `).join('');
});

function showCategoryModal(questionNum) {
    const modal = new bootstrap.Modal(document.getElementById('categoryModal'));
    document.getElementById('saveCategoryBtn').onclick = () => {
        const mainCat = mainCategorySelect.value;
        const subCat = subCategorySelect.value;
        if (mainCat && subCat) {
            categories[questionNum] = { main: mainCat, sub: subCat };
            const items = document.querySelectorAll('.wrong-answer-item');
            for (let item of items) {
                if (item.querySelector('h5').textContent === `Question ${questionNum}`) {
                    item.querySelector('.selected-category').textContent = `Category: ${mainCat} - ${subCat}`;
                    break;
                }
            }
            modal.hide();
        }
    };
    modal.show();
}

document.getElementById('submit-test').addEventListener('click', () => {
    const wrongNums = document.getElementById('wrong-questions').value.split(',')
        .map(n => parseInt(n.trim()))
        .filter(n => !isNaN(n) && n > 0 && n <= currentQuestion);

    const testData = {
        totalQuestions: currentQuestion - 1,
        times: questionTimes,
        wrongQuestions: wrongNums,
        categories: categories
    };

    fetch('/api/submit-test', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(testData)
    })
    .then(response => response.json())
    .then(data => {
        window.location.href = '/results/' + data.test_id;
    });
});
</script>
{% endblock %}
